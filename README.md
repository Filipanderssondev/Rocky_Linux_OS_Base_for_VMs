# Title Page
<img width="100" alt="MyLogo" src="https://github.com/rafaelurrutiasilva/images/blob/main/logos/MyLogo_2.png" align=left><br>
<br>
Titel på dokumentet<br>
Författare<br>
Publiceringsdatum<br>

<br>

## Abstract
Kort sammanfattning av dokumentet

## Table of Contents

1. [Introduction](#introduction)
2. [Goals and Objectives](#goals-and-objectives)
3. [Method](#method)
4. [Target Audience](#target-audience)
5. [Document Status](#document-status)
6. [Disclaimer](#disclaimer)
7. [Scope and Limitations](#scope-and-limitations)
8. [Environment](#environment)
9. [Acknowledgments](#acknowledgments)
10. [References](#references)
11. [Conclusion](#conclusion)

## Introduction
Inledning
Bakgrund och syfte. Eventuell översiktbild här.

## Goals and Objectives
Mål och syften

## Method
### 3.1. Download and verify Rocky Linux

- 3.1.1 Download Rocky Linux <br>
We chose the generic cloud image file (.qcow2), since this is optimal for environments like Proxmox, and is easy to make templates from. 
The current version of Rocky Linux is v10.1 and it's downloaded from the <a href=https://rockylinux.org/download>official site</a>.
Also download the CHECKSUM file.

Open a terminal and go to the download location: <pre>cd ./Downloads</pre>

- 3.1.3 Compute the hash <br>
This can be done with the command:
<pre>sha256sum Rocky-10-GenericCloud-Base.latest.x86_64.qcow2</pre>

Confirm with: <pre>sha256sum -c CHECKSUM | grep OK</pre>

### 3.2. Create a Rocky Linux VM

- 3.2.1 Add the cloud image file <br>
In the Proxmox web-GUI, go to Datacenter > Storage > Local
Add 'Import' to Content list

Then go to Node > Local > Import
Upload the cloud image. 

- 3.2.2 Create a new VM <br>
settings we used:

general
	Name: rocky-base
	Add to HA: No
	Start at boot: No
	
OS: 
	Type: Linux
	Version: 6.x - 2.6 Kernel
	Do not use any media
	
System:
	Graphic Card: Default
	Machine: q35
	BIOS: OVMF (UEFI)
	Add EFI Disk: Yes
	EFI Storage: local-lvm
	Pre-Enroll keys: yes
	SCSI ontroller: VirtiO SCSI single
	
Disks:
	No Disks

CPU:
	Sockets: 1
	Cores: 14
	Type: host

Memory:
	Memory (MiB): 12288
	Ballooning Device: No
	Allow KSM: Yes

Network:
	Bridge: vmbr0
	Model: VirtIO (paravirtualized)
	Vlan Tag: No?
	MAC address: Use the autogenerated address
	Firewall: No

This settings are preliminary and may be changed.

- 3.2.3 Import Hard Disk <br>
Go to the new VM > Hardware > Add > Import Hard Disk
Important Storage: local
Select Image: Rocky-10-GenericCloud-Base.latest.x86_64.qcow2
Target Storage: local-lvm

Also Add > CloudInit Drive

- 3.2.4 Cloud-init settings <br>
Go to the Cloud-Init menu for the VM
Choose a username and password

In IP Config (net0):
We set static ip addresses for our VM, but go with whatever works best for you.

Go to the Options menu for the VM
Change the boot order:
1. scsi0
2. ide2
3. net0

Start the VM and log in.


### 3.3 Configure Rocky Linux

- 3.3.1 Keyboard and Timezone <br>

Swedish keyboard layout:
<pre>sudo localectl set-x11-keymap se
sudo localectl set-keymap se</pre>pre>

Change Timezone:
<pre>sudo timedatectl set-timezone Europe/Stockholm</pre>

- 3.3.2 Update sources <br>
Before updating, we change our repo sources to use a mirror provided by NSC: mirror.nsc.liu.se (https/433).
This step is not necessary if you can run yum update / dnf update directly. For our project, it's the prefered domain. 

In /etc/yum.sources.d, there are a couple of repos that can be changed. We change them with: <pre>vi /etc/yum.repos.d/rocky.repo</pre>

Comment/remove the lines beginning with mirrorlist, and replace http://dl.rockylinux.org with https://mirror.nsc.liu.se in baseurl. Also remove the comment from the baseurl lines. Save and update. 

- 3.3.3 Install additional programs <br>
The Rocky Linux cloud image is purposefully minimal. Though there are some programs we will want available for every instance, and will install on the base OS. After running an update, we installed the following:
bind-utils
bash-completion
tcpdump
traceroute
python3-pip
unzip
zip
nmap
tmux

- 3.3.4 Change console font and size
I felt like I needed to change to fontsize so I researched and researched and finally I found where, as it turns out our tty didnt have a font to begin with so I had to set an existing font to change the font size because it was way to small so all i did was:

<pre>sudo vi /etc/vconsole.conf</pre>

and added: <pre>FONT=sun12x22.psfu.gz</pre>

### 3.4 Firewall Configuration
There is a firewall at every layer in Proxmox (datacenter > node > virtual machine). At the datacenter level, security groups, aliases and IPsets can be created. A security group is a grouping of rules, which can then be quickly applied to nodes and virtual machines. An IP set groups networks and hosts, which can then be added as source and destination properties for firewall rules. 

- 3.4.1 SSH <br>
Go to Datacenter > Firewall > Security Group
Create a new security group with the following configuration:<pre>
Direction: in
Action: ACCEPT
Enable: Yes
Macro: SSH
Log level: info</pre>

Specifications for macros can be found <a href=https://github.com/proxmox/pve-docs/blob/master/pve-firewall-macros.adoc>here</a>.

Go to Datacenter > Firewall > IPSet
Create a new IP set, call it something like management.
Next, create an IP range that covers your management devices.

Now you can go back to the SSH rule and add the management IPSet as source.

- 3.4.2 ICMP <br>
Next, we'll make a new security group for ICMP. There is no macro for ICMP, so it must be selected in the protocol field:
Direction: in
Action: ACCEPT
Enable: Yes
Protocol: icmp
Log level: info

ICMP type can be specified. We'll allow the following types: echo-reply, destination-unreachable, echo-request and time-exceeded. We''ll also add the same rules for IPv6-ICMP.

- 3.4.3 DNS <br>
We'll make a new IP set that points to our organisation's DNS server. We also create a security group for DNS with the following rule:<pre>
Direction: out
Action: ACCEPT
Enable: Yes
Macro: DNS
Destination +dns
Log level: info</pre>

- 3.4.4 Web <br>
We create a new security group for web, and add a new rule:<pre>
Direction: in
Action: ACCEPT
Enable: Yes
Macro: Web
Log level: info</pre>

Proxmox uses 8006 for its own web traffic, so it's important to include that:<pre>
Direction: in
Action: ACCEPT
Enable: Yes
Protocol: tcp
Destination: (Server's IP)
Dest. port: 8006
Log level: info</pre>


- 3.4.5 Block <br>
The last security group will block everything else. For now, we use a single rule:
Direction: In
Action: Reject
Enable: Yes

This rule works as a catch-all, and must be set as the last firewall rule, wheter it's applied at node level or VM level. We chose reject over drop to get instant feedback (connection refused instead of timeout).

- 3.4.6 Set up Firewall
Every security group is added to the rocky-base VM. Double-check that the firewall is enabled at every level. If it's disabled at one level, it will also be disabled at every lower level. Proxmox will apply rules automatically. Go into the server shell to confirm that the firewall is running with: <pre>pve-firewall status</pre>

The firewall can also be compiled to check for errors with: <pre>pve-firewall compile > firewall.txt</pre>

Go into the VM to confirm that the rules work. Try commands like ping, ssh, curl, dig, nc and nmap. 

## Target Audience
Målgrupp

## Document Status
Dokumentstatus (om det finns relevant information om dokumentets status, till exempel utkast, slutfört, etc.). Tex:
> [!NOTE]  
> My work here is not finished yet. I need, among other things, to supplement with instructions on how each component should be configured to work together as well supplement with an overview image that explains how the whole thing works.


## Disclaimer
Ansvarsfriskrivning. Tex:
> [!CAUTION]
> This is intended for learning, testing, and experimentation. The emphasis is not on security or creating an operational environment suitable for production.

## Scope and Limitations
Omfattning och begränsningar

## Environment
Miljö som användes

## Acknowledgments
Tack och erkännanden. Tex:
Big thanks to all the people involved in the material I refer to in my links! I would also like to express gratitude to everyone out there, including my colleagues and friends, who are creating things that help and inspire us to continue learning and exploring this never-ending world of computer technology.

## References
Referenser (om det behövs)

## Conclusion
Slutsats
