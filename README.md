# Rocky Linux Golden Image
<img width="400" alt="" src="https://github.com/Filipanderssondev/Rocky_Linux_OS_Base_for_VMs/blob/main/Images/Rocky_Linux_OS_base.jpg" allign=left><br>

<br>**Authors:** _<a href="https://github.com/Filipanderssondev">Filip Andersson</a> and <a href="https://github.com/JonatanHogild">Jonatan Högild</a>_<br>

12-01-2026<br>


## Abstract
Creating a Rocky Linux golden image OS base for virtual machines on a Proxmox server. <br>
<br>

## Table of Contents

1. [Introduction](#introduction)
2. [Goals and Objectives](#goals-and-objectives)
3. [Method](#method) <br>
   3.1 [Download and verify Rocky Linux](#31-download-and-verify-rocky-linux) <br>
   3.2 [Create a Rocky Linux VM](#32-create-a-rocky-linux-vm)<br>
   3.3 [Configure Rocky Linux](#33-configure-rocky-linux)<br>
   3.4 [Firewall Configuration](#34-firewall-configuration)<br>
   3.5 [Cleaning up and finishing](#35-cleaning-up-and-finishing)<br>
4. [Target Audience](#target-audience)
5. [Document Status](#document-status)
6. [Disclaimer](#disclaimer)
7. [Scope and Limitations](#scope-and-limitations)
8. [Environment](#environment)
9. [Acknowledgments](#acknowledgments)
10. [References](#references)
11. [Conclusion](#conclusion)

## Introduction
This project is the second <a href="https://github.com/rafaelurrutiasilva/Proxmox_on_Nuc/blob/main/Extra/Mermaid/Projects.md">in a series of projects</a>, with the goal of setting up a complete virtualized, automated, and monitored IT-Enviroment as a part of our internship at [The Swedish Meteorological and Hydrological Institute (SMHI)](https://www.smhi.se/en/about-smhi). Previously, <a href=https://github.com/rafaelurrutiasilva/Proxmox_on_Nuc>Proxmox was installed and configured</a> on a server. Here, we will prepare a Rocky Linux golden image for cloning. A <a href=https://www.redhat.com/en/topics/linux/what-is-a-golden-image>golden image</a> serves as a baseline template for replication, reducing repetitive setup and ensuring consistency. When ready, a template will be created from the Rocky Linux image, and then cloned. <br>

**<a href="https://github.com/Filipanderssondev">Filip Andersson</a> and <a href="https://github.com/JonatanHogild">Jonatan Högild</a>**

## Goals and Objectives
This is part of a larger ongoing Infrastructure as Code (IaC) project that will use Proxmox as a base, with Rocky Linux as the OS running on each virtual machine. 
The goal of this project is to build a complete IT-environment and gain a deeper understanding of the underlying components and their part in a larger production chain.

## Method
### 3.1. Download and verify Rocky Linux

#### 3.1.1. **Download Rocky Linux** <br>

Instead of a regular .ISO file, we chose the generic cloud image file (.qcow2), since this is optimal for environments like Proxmox, and ideal to make templates from. 
The current version of Rocky Linux is v10.1 and it's downloaded from the <a href=https://rockylinux.org/download>official site</a>.
Also download the CHECKSUM file.

Open a terminal and go to the download location: `cd ./Downloads`

#### 3.1.2 **Compute the hash** <br>

This can be done with: `sha256sum Rocky-10-GenericCloud-Base.latest.x86_64.qcow2`

Confirm with: `sha256sum -c CHECKSUM | grep OK`

### 3.2. Create a Rocky Linux VM

#### 3.2.1 **Add the cloud image file** <br>

In the Proxmox web-GUI, go to Datacenter > Storage > Local <br>
Add *Import* to Content list.

Then go to Node > Local > Import <br>
Upload the cloud image. 

#### 3.2.2 **Create a new VM** <br>

Now create a VM by clicking the blue button *Create VM* in the topright corner. 

settings we used:<br>
<pre>
General: <br>
	Name: rocky-base <br>
	Add to HA: No <br>
	Start at boot: No <br>
	
OS: <br>
	Type: Linux <br>
	Version: 6.x - 2.6 Kernel <br>
	Do not use any media <br>
	
System: <br>
	Graphic Card: Default <br>
	Machine: q35 <br>
	BIOS: OVMF (UEFI) <br>
	Add EFI Disk: Yes <br>
	EFI Storage: local-lvm <br>
	Pre-Enroll keys: yes <br>
	SCSI ontroller: VirtiO SCSI single <br>
	
Disks: <br>
	No Disks <br>

CPU: <br>
	Sockets: 1 <br>
	Cores: 14 <br>
	Type: host <br>

Memory: <br>
	Memory (MiB): 4096 <br>
	Ballooning Device: No <br>
	Allow KSM: Yes <br>

Network: <br>
	Bridge: vmbr0 <br>
	Model: VirtIO (paravirtualized) <br>
	Vlan Tag: No <br>
	MAC address: Use the autogenerated address <br>
	Firewall: Yes <br>
</pre>

These settings are preliminary and may be changed. Our server has an Intel® Core™ i7-12700H Processor with 14 cores, 64GB of RAM and 1TB of storage. Assigning all 14 cores to every VM may cause contention, so we'll monitor this. The lightweight version of Rocky Linux <a href=https://docs.rockylinux.org/10/guides/minimum_hardware_requirements>requires about 1GB of RAM</a>, so 4GB should be enough for a single VM. Hard disk size is set to 10GB by default. The size may be increased later on, and is evaluated on a per-VM basis.


#### 3.2.3 **Import Hard Disk** <br>

Go to the new VM > Hardware > Add > Import Hard Disk <br>
Important Storage: local <br>
Select Image: Rocky-10-GenericCloud-Base.latest.x86_64.qcow2 <br>
Target Storage: local-lvm

Also Add > CloudInit Drive

#### 3.2.4 **Cloud-init settings** <br>

Go to the Cloud-Init menu for the VM <br>
Choose a username and password

In IP Config (net0): <br>
We set static ip addresses for our VM, but go with whatever works best for you.

Go to the Options menu for the VM <br>
Change the boot order: <br>
1. scsi0 <br>
2. ide2 <br>
3. net0 <br>

Start the VM and log in.


### 3.3 Configure Rocky Linux

#### 3.3.1 **Keyboard and Timezone** <br>

Swedish keyboard layout: `sudo localectl set-keymap se`

Change Timezone: `sudo timedatectl set-timezone Europe/Stockholm`

#### 3.3.2 **Update sources** <br>

Before updating, we change our repo sources to use a mirror provided by NSC: *mirror.nsc.liu.se* (https/433).
This step is not necessary if you can run `yum update` / `dnf update` directly. For our project, it's the prefered domain. 

In */etc/yum.sources.d*, there are a couple of repos that can be changed. We change them with: `vi /etc/yum.repos.d/rocky.repo`

Comment/remove the lines beginning with mirrorlist, and replace *http://dl.rockylinux.org* with *https://mirror.nsc.liu.se* in baseurl. Also remove the comment from the baseurl lines. Save and update. 

#### 3.3.3 **Install additional programs** <br>

The Rocky Linux cloud image is purposefully minimal. Though there are some programs we'll want available for every clone, and will install here. After running an update, we installed the following: <br>
bind-utils <br>
bash-completion <br>
tcpdump <br>
traceroute <br>
python3-pip <br>
unzip <br>
zip <br>
nmap <br>
tmux <br>

#### 3.3.4 **Change console font and size** <br>

I felt like I needed to change to fontsize so I researched and researched and finally I found where, as it turns out our tty didnt have a font to begin with so I had to set an existing font to change the font size because it was way to small so all i did was: `sudo vi /etc/vconsole.conf`

and added: `FONT=sun12x22.psfu.gz`

#### 3.3.5 **Add users** <br>

We added a new user for each of us and placed these in the wheel group:
```bash
	useradd jonatan
	useradd Filip
	usermod -aG wheel jonatan
	usermod -aG wheel Filip
```

### 3.4 Firewall Configuration

There is a firewall at every layer in Proxmox (datacenter > node > virtual machine). At the datacenter level, security groups, aliases and IPsets can be created. A security group is a grouping of rules, which can then be quickly applied to nodes and virtual machines. An IP set groups networks and hosts, which can then be added as source and destination properties for firewall rules.

This firewall will be designed to be only as permissive as it needs to be. Initially, we'll identify which protocols we need to use, and make rules for these. As the project evolves, so will the firewall, and new rules will be added later on. 

#### 3.4.1 **SSH** <br>

Go to Datacenter > Firewall > Security Group
Create a new security group with the following configuration:<pre>
Direction: in
Action: ACCEPT
Enable: Yes
Macro: SSH
Log level: info</pre>

Set logging to whichever level you prefer, or keep it turned off if you like. *Debug* may be a bit too verbose, so we chose *info* as our baseline. 

We'll also make a copy of the rule, and set its direction to *out*.

Specifications for macros can be found <a href=https://github.com/proxmox/pve-docs/blob/master/pve-firewall-macros.adoc>here</a>.

#### 3.4.2 **ICMP** <br>

Next, we'll make a new security group for ICMP. There is no macro for ICMP, so it must be selected in the protocol field:<pre>
Direction: in
Action: ACCEPT
Enable: Yes
Protocol: icmp
Log level: info</pre>

ICMP type can be specified. We'll allow the following types: echo-reply, destination-unreachable, echo-request and time-exceeded. These rules allow for troubleshooting, without being too permissive. We'll also add the same rules for IPv6-ICMP. Next, make a copy of every rule, with the direction set to *out*. In total, there will be 16 ICMP rules. 

Create a new security group, and call it something like *allow-ipv6*. This group will contain rules for IPv6-ICMP types that enable basic IPv6 functionality. The following types will be allowed: packet too big (2), router solicitation (133), router advertisment (134), neighbour solicitation (135) and neighbour advertisment (136). Like before, create a copy of each rule with an outbound direction. 

#### 3.4.3 **DNS** <br>

Go to Datacenter > Firewall > IPSet
Create a new IP set and call it dns. Add the IP-address of your DNS-server. 

Create a security group for DNS with the following rule:<pre>
Direction: out
Action: ACCEPT
Enable: Yes
Macro: DNS
Destination +dns
Log level: info</pre>

#### 3.4.4 **Web** <br>

We create a new security group for web, and add a new rule:<pre>
Direction: in
Action: ACCEPT
Enable: Yes
Macro: Web
Log level: info</pre>

Note that this macro allows both HTTP and HTTPS. Consider if a second rule for outbound web traffic will be necessary. For our lab, it will be, so we'll add it.

#### 3.4.5 **NTP** <br>

Security group for NTP, with the rule:<pre>
Direction: out
Action: ACCEPT
Enable: Yes
Macro: NTP
Log level: info</pre>

#### 3.4.6 **Block all other traffic** <br>

The last security group will block everything else, call it something like *drop-everything* and make two new rules:<pre>
Direction: In
Action: Drop
Enable: Yes</pre>

<pre>
Direction: Out
Action: Drop
Enable: Yes</pre>

These rules works as a catch-all, and must be set as the last in the rule-matching order. It might be worth considering wheter to use *drop* or *reject*. 
Reject usually gives instant feedback (connection refused instead of timeout) and is more convenient for a lab environment. Drop, however, is less prone to leak information.

#### 3.4.7 **Set up Firewall**<br>

Add the security-groups to the rocky-base VM. The order we selected is: <br>
allow-icmp <br>
allow-ssh <br>
allow-dns <br>
allow-ntp <br>
allow-web <br>
drop-everything <br>

For further hardening, configure the firewall options on the VM level: <br>
Firewall - On  <br>
DHCP - Off (we're not using DHCP in this lab) <br>
NDP - On (necessary for IPv6 functionality) <br>
Router Advertisment - On (also used by IPv6) <br>
MAC filter - On (prevents MAC-address spoofing) <br>
IP filter - Off (prevents IP-address spoofing, causes issues so it's turned off) <br>
log_level_in - info  <br>
log_level_out - info <br>
Input Policy - DROP (drops traffic when no rule matches, does what the drop-everything-rule does) <br>
Output Policy - DROP <br>

Double-check that the firewall is enabled. If it's disabled at one level, it will also be disabled at every lower level. You can go into the server shell to confirm that the firewall is running with: `pve-firewall status`

The firewall can also be compiled to check for errors with: `pve-firewall compile`

Go into the VM to confirm that the rules work. Try commands like ping, ssh, curl, dig, nc and nmap.

### 3.5 Cleaning up and finishing

The VM is almost ready to be copied. One final thing to do is cleaning up temporary and machine-specific files.

#### 3.5.1 **Clear DNF/YUN cache, metadata and tmp files** <br>

Package-manager leftovers can be cleared with this command: `sudo dnf clean all`

#### 3.5.2 **Temporary files** <br>

Remove any files left in temporary folders:
```bash
sudo rm -rf /tmp/*
sudo rm -rf /var/tmp/*
```

#### 3.5.3 **Machine ID** <br>

Machine-id is autogenerated on installation/boot. It's used by systemd, d-bus, networkmanager, and sometimes licenses and UUID-based apps:
```bash
sudo truncate -s 0 /etc/machine-id
sudo rm -f /var/lib/dbus/machine-id
```

#### 3.5.4 **Shell history** <br>

Not strictly necessary to remove, but command history could reveal sensetive information. 
```bash
history -c  
rm -f ~/.bash_history
```

#### 3.5.4 **Create Template and clones** <br>

Shut down the VM, then convert it to a template. This template can now be easily cloned. We'll make 3 clones: 
- mgmt-01
- metrics-01
- app-01

We recommend using the *Linked Clone* mode, for potential performance gain. 

The clones will be given new VM IDs, and new static IP addresses. That's all the setup needed in the cloning process. 

#### 3.5.5 IPSet for management
Go to Datacenter > Firewall > IPSet
Create a new IP set, call it something like management.
Next, create an IP range that covers your management devices.


## Target Audience
This repo is for anyone who wants a step-by-step guide on preparing a Rocky Linux golden image for Proxmox. 
This repo is also part of a larger project aimed at people interested in learning about IaC, and building such an environment from scratch. 

## Document Status
> [!NOTE]  
> This is a work in progress.<br>
> This repo is part of a larger ongoing project.
<br>

## Disclaimer
> [!CAUTION]
> This is intended for learning, testing, and experimentation. The emphasis is not on security or creating an operational environment suitable for production.
<br>

## Scope and Limitations
- ### 7.1. Scope
   * Instructions for installing and configuring Rocky Linux as a golden image.
   * Instructions for how to work within Proxmox VE (9.1.1), create and manage VMs. 

- ### 7.2. Limitations
   * This guide is not intended for production-grade, multi-node clusters or advanced HA setups.
   * Hardware compatibility varies; If unsure, check <a href=https://docs.rockylinux.org/10/guides/minimum_hardware_requirements>hardware requirements</a> before proceeding. 
   * Network configuration is for now limited to a single-node setup and may not apply to complex environments.
   * Instructions may become outdated as software updates; always verify with the official documentation.
<br>

## Environment
- ### 8.1. Hardware
   - Asus PN64 ax210NGW.

- ### 8.2. Software
   - RHEL was used for downloading Rocky Linux.
   - Proxmox was used extensively in this project.
<br>

## Acknowledgments
- We would like to thank <a href=https://github.com/rafaelurrutiasilva>Rafael Urrutia</a> for his continuous support and guidance.

## References
- [SMHI](https://www.smhi.se/en/about-smhi)
- [What is a golden image](https://www.redhat.com/en/topics/linux/what-is-a-golden-image )
- [Rocky Linux Download Page](https://rockylinux.org/download)
- [Rocky Linux hardware requirements](https://docs.rockylinux.org/10/guides/minimum_hardware_requirements)
- [Proxmox Firewall Macros](https://github.com/proxmox/pve-docs/blob/master/pve-firewall-macros.adoc)
- [Project 1: Proxmox on Nuc](https://github.com/rafaelurrutiasilva/Proxmox_on_Nuc)
<br>

## Conclusion
The aim of this project was to prepare a Rocky Linux install to use as a golden image. We strived to keep it minimal, yet include a set of binaries that will be useful throughout the project. This project also helped us further explore Proxmox and virtualization, and we have become more familiar with these as a result. 
